name: Release

on:
  release:
    types: [published]
  workflow_call:
    inputs:
      tag:
        required: true
        type: string

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: tag
        run: echo "name=${{ inputs.tag || github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache Pebble SDK
        uses: actions/cache@v4
        id: sdk-cache
        with:
          path: ~/.pebble-sdk
          key: pebble-sdk-latest-v2

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsdl1.2debian libfdt1 npm xvfb

      - name: Install pebble-tool
        run: pip install pebble-tool

      - name: Install Pebble SDK
        if: steps.sdk-cache.outputs.cache-hit != 'true'
        run: pebble sdk install latest

      - name: Build watchface
        run: pebble build

      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 400x400x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Generate screenshots
        run: |
          mkdir -p screenshots

          for platform in aplite basalt diorite chalk; do
            echo "Capturing screenshot for $platform..."
            pebble install --emulator $platform build/*.pbw
            sleep 5
            pebble screenshot --emulator $platform --no-open screenshots/$platform.png
            pebble kill || true
            sleep 2
          done

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Upload .pbw
          gh release upload ${{ steps.tag.outputs.name }} build/nortid.pbw --clobber

          # Upload screenshots
          for platform in aplite basalt diorite chalk; do
            gh release upload ${{ steps.tag.outputs.name }} screenshots/${platform}.png --clobber
          done

      - name: Update release notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT_BODY=$(gh release view ${{ steps.tag.outputs.name }} --json body -q .body)

          NEW_BODY="${CURRENT_BODY}

          ---

          ## Screenshots

          | aplite | basalt | diorite | chalk |
          |:------:|:------:|:-------:|:-----:|
          | ![aplite](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.name }}/aplite.png) | ![basalt](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.name }}/basalt.png) | ![diorite](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.name }}/diorite.png) | ![chalk](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.name }}/chalk.png) |
          | Pebble Classic | Pebble Time | Pebble 2 | Time Round |

          ## Installation

          1. Download \`nortid.pbw\` above
          2. Send to your Pebble via the Pebble app or Rebble sideloading

          To submit to Rebble appstore: [help.rebble.io/appstore-submission](https://help.rebble.io/appstore-submission/)"

          gh release edit ${{ steps.tag.outputs.name }} --notes "$NEW_BODY"
